#! /usr/bin/env bash

if [[ $1 == -@(h|-h)* ]]
then
cat << 'HELP'
Usage:
layout {host prefix} [number of hosts (>1, default: 3)] OR
       host1 host2 ...
HELP
exit 0
fi

nb_sessions="$(tmux ls -F#S 2>/dev/null | wc -l)"

if ((nb_sessions == 0))
then
   tmux new -s tiles -d
fi

if (($# <= 1)) || { (($# == 2)) && [[ $2 == [0-9]* ]]; }
then
   if (($# == 0))
   then
      read -p 'Common host prefix: ' prefix
      read -p 'Number of hosts: ' nb_hosts
   else
      prefix="$1"
      nb_hosts="${2:-3}"
   fi
   [[ $2 == [01] ]] && { echo "Abort. The second arg must be > 1" 1>&2; exit 1; }

   tmux new-window -n "$prefix" "ssh ${prefix}1"

   for ((i = 2; i < nb_hosts + 1; i++))
   do
      tmux split-window -h "ssh ${prefix}$i"
      ((i < 4)) && continue
      tmux select-layout tiled >/dev/null
   done
else
   tmux new-window -n 'multi' "ssh $1"

   j=2
   for h in "${@:2}"
   do
      tmux split-window -h "ssh $h"
      ((j++ < 4)) && continue
      tmux select-layout tiled >/dev/null
   done
fi

if { [[ $nb_hosts ]] && ((nb_hosts < 4)); } || { [[ ! $nb_hosts ]] && (($# < 4)); }
then
   tmux select-layout even-horizontal >/dev/null
fi

tmux select-pane -t 1
tmux set-window-option synchronize-panes on >/dev/null

if ((nb_sessions == 0))
then
   tmux kill-window -t1
   tmux attach -t tiles
fi
